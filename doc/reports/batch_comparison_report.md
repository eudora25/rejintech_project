# 🔧 배치 시스템 비교 분석 보고서

## 📋 비교 개요

**분석 일시**: 2025년 6월 28일  
**대상**: 로컬 vs 서버 배치 시스템  
**목적**: 서버 데이터 누락 원인 분석  

## 📊 로컬 배치 시스템 현황

### 🔧 배치 컨트롤러 (PHP)

#### 1. **data_normalization.php** (23KB, 544라인)
- **역할**: delivery_request_details → 정규화된 테이블로 데이터 분산
- **주요 기능**:
  - 테이블 초기화 (companies, institutions, products 등)
  - 정규화된 데이터 생성 및 삽입
  - 트랜잭션 기반 안전한 처리
- **실행 방식**: CLI 또는 웹 (인증 키: `rejintech_batch_2025`)

#### 2. **Procurement_sync.php** (19KB, 431라인)
- **역할**: 조달청 API에서 데이터 수집
- **주요 기능**:
  - 공공데이터 API 호출
  - 데이터 변환 및 저장
  - 필터링 업체 처리
- **실행 방식**: CLI 또는 웹 (인증 키: `rejintech_batch_2025`)

#### 3. **Data_sync_process.php** (16KB, 395라인)
- **역할**: 통합 프로세스 관리자
- **주요 기능**:
  1. 공공데이터 수집 (`Procurement_sync`)
  2. 데이터 정규화 (`data_normalization`)
  3. 처리된 데이터 정리
- **실행 방식**: CLI 전용 (보안 강화)

### 🛠️ 배치 스크립트 (Shell/PHP)

#### 1. **rejintech_batch.sh** (2.5KB, 실행권한)
```bash
# 주요 특징:
- Docker 컨테이너 상태 확인
- 락 파일을 통한 중복 실행 방지
- 로그 관리 (/var/log/rejintech/)
- Data_sync_process.php 실행
```

#### 2. **run_normalization.php** (9.7KB, Standalone)
```php
# 주요 특징:
- CodeIgniter 독립 실행
- 직접 PDO 연결
- 트랜잭션 기반 처리
- 메모리 1G 제한
```

#### 3. **crontab 설정 예시**
```bash
# 권장 스케줄
0 2 * * * /path/to/rejintech_batch.sh
```

## 🚨 서버 배치 시스템 문제점 발견

### 1. **API 엔드포인트 누락**
```bash
# 로컬에 있는 API
/api/test/health → 서버에서 404 오류

# 이는 다음을 의미:
- 서버의 Test.php 컨트롤러에 health() 메서드 없음
- 로컬과 서버의 코드가 동기화되지 않음
```

### 2. **배치 실행 흔적 부족**
- 서버 DB에 핵심 데이터가 모두 0개
- 배치 작업이 실행되지 않았거나 실패한 상태

### 3. **추정되는 서버 배치 시스템 상태**
```
❌ 배치 컨트롤러 미동기화
❌ cron 작업 미설정 또는 실패
❌ 데이터 정규화 프로세스 미실행
❌ API 수집 작업 미실행
```

## 🔍 로컬과 서버 차이점 분석

### 📁 파일 구조 차이

| 구분 | 로컬 | 서버 (추정) |
|------|------|-------------|
| **data_normalization.php** | ✅ 최신 (23KB) | ❓ 구버전 또는 없음 |
| **Procurement_sync.php** | ✅ 최신 (19KB) | ❓ 구버전 또는 없음 |
| **Data_sync_process.php** | ✅ 최신 (16KB) | ❓ 없음 |
| **Test.php** | ✅ health() 메서드 포함 | ❌ health() 메서드 없음 |
| **배치 스크립트** | ✅ 완비 | ❓ 미확인 |

### 🔧 기능 차이점

#### 로컬 시스템의 고급 기능들
1. **통합 프로세스 관리**
   - `Data_sync_process.php`로 전체 워크플로우 관리
   - 3단계 처리: 수집 → 정규화 → 정리

2. **강화된 보안**
   - CLI 전용 실행 (Data_sync_process)
   - 웹 실행 시 인증 키 필요

3. **개선된 오류 처리**
   - 트랜잭션 기반 안전한 처리
   - 상세한 로깅 및 상태 모니터링

4. **시스템 모니터링**
   - `/api/test/health` 엔드포인트
   - 시스템 상태 실시간 확인

#### 서버에 누락된 것으로 추정되는 기능들
1. ❌ **통합 프로세스 관리자**
2. ❌ **시스템 헬스체크 API**
3. ❌ **최신 배치 로직**
4. ❌ **cron 작업 설정**

## 🚨 원인 분석: 왜 서버에 데이터가 없는가?

### 1차 원인: **코드 동기화 실패**
```
로컬 개발 → 서버 배포 과정에서 누락
- 최신 배치 코드가 서버에 반영되지 않음
- Data_sync_process.php 파일 누락
- Test.php의 health() 메서드 누락
```

### 2차 원인: **cron 작업 미설정**
```
서버에 cron 작업이 설정되지 않았거나 실패
- rejintech_batch.sh 실행 안됨
- 수동 배치 실행도 안됨
```

### 3차 원인: **Docker 환경 차이**
```
로컬과 서버의 Docker 설정 차이
- 컨테이너 권한 문제
- 볼륨 마운트 차이
- 환경 변수 설정 차이
```

## 📝 해결 방안

### 🔥 즉시 조치 (긴급)

#### 1. **서버 코드 동기화**
```bash
# 서버에 최신 배치 코드 배포
scp source/application/controllers/batch/* server:/var/www/html/application/controllers/batch/
scp scripts/* server:/scripts/
```

#### 2. **수동 배치 실행**
```bash
# 서버에서 직접 실행
docker exec rejintech-workspace php /var/www/html/index.php batch/data_sync_process start
```

#### 3. **cron 작업 설정**
```bash
# 서버에 cron 작업 추가
0 2 * * * /path/to/rejintech_batch.sh
```

### 🔧 중기 조치 (안정화)

#### 1. **배포 자동화**
- Git을 통한 코드 버전 관리
- 배포 스크립트 작성
- CI/CD 파이프라인 구축

#### 2. **모니터링 강화**
- 배치 실행 상태 모니터링
- 데이터 수량 변화 추적
- 오류 알림 시스템

#### 3. **백업 전략**
- 정기적인 데이터베이스 백업
- 배치 실행 로그 보관
- 복구 절차 문서화

### 📊 장기 조치 (최적화)

#### 1. **인프라 개선**
- 서버 리소스 모니터링
- 배치 성능 최적화
- 장애 복구 자동화

#### 2. **운영 프로세스**
- 배치 실행 일정 최적화
- 데이터 품질 관리
- 운영 매뉴얼 작성

## 🎯 결론

### 현재 상황
🚨 **서버의 배치 시스템이 로컬과 완전히 다른 상태로, 핵심 데이터가 누락되어 있습니다.**

### 주요 원인
1. **코드 동기화 실패** (가장 큰 원인)
2. **배치 작업 미실행**
3. **시스템 모니터링 부족**

### 해결 우선순위
1. **1순위**: 서버 코드 동기화 및 배치 실행
2. **2순위**: cron 작업 설정
3. **3순위**: 모니터링 시스템 구축

### 예상 복구 시간
- **긴급 조치**: 1-2시간 (코드 동기화 + 수동 실행)
- **안정화**: 1-2일 (cron 설정 + 모니터링)
- **완전 복구**: 1주일 (자동화 + 문서화)

---
**다음 단계**: 서버 코드 동기화 및 배치 작업 즉시 실행 필요! 🚀 